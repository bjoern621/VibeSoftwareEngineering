name: Docker Compose Build

on:
    push:
        branches: ["*"]
    pull_request:
        branches: ["*"]
    workflow_dispatch:

jobs:
    docker-compose-build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker Compose Stack
              working-directory: ConcertComparison
              run: docker compose build

            - name: Start Docker Compose Stack
              working-directory: ConcertComparison
              run: |
                  docker compose up -d
                  echo "Waiting for services to start..."
                  sleep 60

            - name: Check Backend Health
              run: |
                  for i in {1..30}; do
                    if curl -s http://localhost:8080/api/actuator/health > /dev/null; then
                      echo "Backend is healthy!"
                      exit 0
                    fi
                    echo "Waiting for backend... attempt $i"
                    sleep 2
                  done
                  echo "Backend health check failed"
                  docker compose -f ConcertComparison/docker-compose.yml logs backend
                  exit 1

            - name: Check Frontend Health
              run: |
                  for i in {1..15}; do
                    if curl -s http://localhost:3000 > /dev/null; then
                      echo "Frontend is healthy!"
                      exit 0
                    fi
                    echo "Waiting for frontend... attempt $i"
                    sleep 2
                  done
                  echo "Frontend health check failed"
                  docker compose -f ConcertComparison/docker-compose.yml logs frontend
                  exit 1

            - name: Show Running Containers
              if: always()
              run: docker ps -a

            - name: Show Docker Compose Logs
              if: failure()
              working-directory: ConcertComparison
              run: docker compose logs

            - name: Stop Docker Compose Stack
              if: always()
              working-directory: ConcertComparison
              run: docker compose down
