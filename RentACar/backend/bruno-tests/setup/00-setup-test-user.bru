meta {
  name: 00 - Setup Test User
  type: http
  seq: 0
}

post {
  url: {{baseUrl}}/api/kunden/registrierung
  body: json
  auth: none
}

body:json {
  {
    "email": "test.customer@example.com",
    "password": "Test1234!",
    "firstName": "Bruno",
    "lastName": "Testuser",
    "phoneNumber": "+49 30 12345678",
    "street": "Teststraße 123",
    "postalCode": "10115",
    "city": "Berlin",
    "driverLicenseNumber": "B1234567890"
  }
}

tests {
  test("User created or already exists", function() {
    expect([201, 400, 409]).to.include(res.status);
  });
}

script:post-response {
  // Nach Registrierung direkt Login durchführen um Token zu holen
  const axios = require('axios');
  const baseUrl = bru.getEnvVar("baseUrl");
  
  try {
    const loginRes = await axios.post(`${baseUrl}/api/kunden/login`, {
      email: "test.customer@example.com",
      password: "Test1234!"
    });
    
    if (loginRes.data && loginRes.data.token) {
      bru.setEnvVar("authToken", loginRes.data.token);
      bru.setEnvVar("customerId", loginRes.data.customerId);
    }
  } catch (e) {
    console.log("Login after registration failed:", e.message);
  }
}
