meta {
  name: 03 - Update Profile
  type: http
  seq: 3
}

put {
  url: {{baseUrl}}/api/kunden/profil
  body: json
  auth: bearer
}

auth:bearer {
  token: {{authToken}}
}

script:pre-request {
  const axios = require('axios');
  const baseUrl = bru.getEnvVar("baseUrl");
  const token = bru.getEnvVar("authToken");
  
  if (!token || token === "") {
    try {
      const loginRes = await axios.post(`${baseUrl}/api/kunden/login`, {
        email: "test.customer@example.com",
        password: "Test1234!"
      });
      if (loginRes.data && loginRes.data.token) {
        bru.setEnvVar("authToken", loginRes.data.token);
      }
    } catch (e) {
      console.log("Auto-login failed:", e.message);
    }
  }
}

body:json {
  {
    "firstName": "Bruno",
    "lastName": "Testuser",
    "email": "test.customer@example.com",
    "phoneNumber": "+49 30 99999999",
    "street": "Neue Straße 456",
    "postalCode": "10178",
    "city": "Berlin"
  }
}

tests {
  test("Status is 200 OK", function() {
    expect(res.status).to.equal(200);
  });

  test("Phone number updated", function() {
    expect(res.body.phoneNumber).to.be.a("string");
    expect(res.body.phoneNumber).to.include("99999999");
  });

  test("Address updated", function() {
    expect(res.body.street).to.equal("Neue Straße 456");
    expect(res.body.postalCode).to.equal("10178");
  });
}
